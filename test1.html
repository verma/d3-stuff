<html>
<head>
<title>Testing D3.js</title>
<script src="d3.v2.min.js"></script>
<script src="underscore-min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<style type="text/css">

circle {
  fill: #dddddd;
  stroke: #333333;
}

.company-name {
  font-family: sans-serif;
  text-transform: uppercase;
  fill: white;
  fill-opacity: 50%;
  font-size: 20px;
  font-weight: 200;
  letter-spacing: 1px;
}

</style>
<script>
$(document).ready(function() {
  var width = 800;
  var height = 300;

  console.log("starting up D3...");
  var svg = d3.selectAll("#body").append("svg:svg")
  .attr("width", width)
  .attr("height", height)
  .style("background-color", "#eer");

  data = [
    { company: 'Super awesome bond company',
      bonds: [
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 125000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 325000000 }]},
    { company:'Company B',
      bonds:[
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 25000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 85000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 45000000 }]},
    { company:'Bank of America',
      bonds:[
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 85000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 45000000 }]},
    { company:'US Bank',
      bonds:[
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 85000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 225000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 45000000 }]},
    { company:'Company C',
      bonds:[
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 25000000 },
      { 'maturity_date': '2025-01-01',
        'issue_date': '2005-01-01',
        'amount': 45000000 }]}
  ]

  var bonds_acc =
    _.reduce(data, function(acc, b) { 
      return acc.concat(_.last(acc) + _.size(b.bonds)); }, [0]);
  total_bonds = _.last(bonds_acc);

  console.log(bonds_acc);
  console.log(total_bonds);

  var offset = d3.scale.linear().
    domain([0, _.max(bonds_acc)]).
    range([0, width]);

  console.log(_.max(data, function(d) { return _.size(d.bonds); }));

  var colorscale = d3.scale.linear().
    domain([0, _.max(_.map(data, function(d) { return _.size(d.bonds); }))]).
    range([90, 30]); // darker are important

  console.log(colorscale(3));

  var node = svg.selectAll('g').data(data).
    enter().append('g').
    attr('transform', function(d, i) { return 'translate(' + offset(bonds_acc[i]) + ', 0)'; });

  node.append('rect').
    attr('x', 0).
    attr('y', 0).
    attr('width', function(d, i) { return offset(bonds_acc[i+1]) - offset(bonds_acc[i]) + 1; }).
    attr('height', height).
    style('fill', function(d) { return 'hsl(282, 28%, ' + colorscale(_.size(d.bonds)) + '%)'; });

  node.append("text").
    attr('class', 'company-name').
    attr('y', 0).
    attr('dy', '1em').
    attr('transform', 'translate(0, ' + (height - 15) + ') rotate(-90)').
    text(function(d) { return d.company; });
});
</script>
</head>

<body>
  <div id="body">
  </div>

</body>

</html>
